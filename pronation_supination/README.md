# Анализ пронации-супинации кистей

Система для компьютерного анализа вращательных движений кистей с оценкой по шкале 0-4 согласно клиническим стандартам.

## Описание теста

Испытуемому необходимо выполнить серию попеременных вращательных движений кистью, поворачивая ладонь вверх и вниз с максимальной скоростью и амплитудой.

### Условия проведения функциональной пробы

- Каждая рука тестируется отдельно
- Система анализирует параметры:
  - **ритмичность** движений
  - **плавность** движений  
  - **возможные остановки** и задержки
  - **уменьшение амплитуды** во времени

- Важно определить, на каком этапе выполнения задания появляются отклонения:
  - в конце
  - середине  
  - сразу после начала

### Оцениваемые области
- Правая рука
- Левая рука

### Количество категорий
5 категорий, характеризующих оценку: **4, 3, 2, 1, 0**

### Качество категорий
(от наибольшего уровня неврологической декомпенсации до минимального уровня):
- **4** - Критичные нарушения: невозможность выполнения движения
- **3** - Плохое выполнение: выраженные нарушения, значительное замедление
- **2** - Удовлетворительное выполнение: умеренные нарушения ритма или амплитуды
- **1** - Хорошее выполнение: незначительные отклонения в ритме или амплитуде
- **0** - Отличное выполнение: полная амплитуда, стабильный ритм, высокая скорость

## Техническая составляющая обработки

### Входные данные
- **Запрос на обработку**: матрица координат ключевых точек кисти
- **Формат**: двумерный массив (кадры × координаты)
- **Координаты**: 21 ключевая точка × 3 координаты (x, y, z) = 63 значения на кадр

### Процесс обработки

1. **Обработка матрицы**
   - Валидация входных данных
   - Расчет углов пронации-супинации
   - Детекция циклов движений

2. **Получение "сырых" данных**
   - Амплитуда движений
   - Частота циклов
   - Ритмичность
   - Плавность движений

3. **Оценивание по шкале 0-4**
   - Анализ 8 ключевых критериев
   - Временная локализация нарушений
   - Классификация качества выполнения

### Результат обработки

Обработчик возвращает в API-шлюз:

```json
{
  "success": true,
  "test_score": 2,                    // Оценка теста (0-4)
  "min_score": 0,                      // Минимальное значение шкалы
  "max_score": 4,                      // Максимальное значение шкалы
  "technical_score": 2,                // Техническая оценка
  "detailed_metrics": {
    "num_cycles": 5,                   // Количество циклов
    "mean_amplitude": 45.2,            // Средняя амплитуда (градусы)
    "frequency": 1.8,                  // Частота движений (Гц)
    "rhythm_consistency": 0.75,        // Ритмичность (0-1)
    "speed_consistency": 0.68,         // Стабильность скорости (0-1)
    "amplitude_consistency": 0.82,      // Стабильность амплитуды (0-1)
    "smoothness": 0.71,                // Плавность движений (0-1)
    "stops_detected": 0.15,            // Доля остановок (0-1)
    "amplitude_decrease": 0.12         // Уменьшение амплитуды (0-1)
  },
  "temporal_patterns": {
    "early_violations": 0.05,          // Нарушения в начале (0-1)
    "mid_violations": 0.12,            // Нарушения в середине (0-1)
    "late_violations": 0.25            // Нарушения в конце (0-1)
  },
  "interpretation": "Удовлетворительное выполнение: умеренные нарушения ритма или амплитуды"
}
```

## Установка

```bash
# Клонирование репозитория
git clone <repository_url>
cd pronation_supination

# Установка зависимостей
pip install -r requirements.txt
```

## Использование

### 1. Трекинг кисти из видео (YOLOv11n + MediaPipe)

```bash
# Сохранить данные трекинга (автовыбор активной руки, без окна вывода)
python wrist_tracker.py --input test_video.mp4 --output wrist_data.csv --no-display

# Порог уверенности детекции (по умолчанию 0.3)
python wrist_tracker.py --input test_video.mp4 --output wrist_data.csv --confidence 0.5 --no-display
```

Особенности:
- Используется модель `yolov11n.pt`. При первом запуске она автоматически скачается и сохранится рядом со скриптом.
- Рука определяется автоматически по максимальной амплитуде движений (не требуется указывать левую/правую).

### 2. Анализ сохранённых данных трекинга

```bash
# Получить клиническую и техническую оценку, построить графики
python wrist_analyzer.py --input wrist_data.csv --output analysis_results.csv --plot
```

### 3. Прямое использование модулей

```python
from wrist_tracker import WristPronationSupinationTracker
from wrist_analyzer import PronationSupinationAnalyzer

# Трекинг
tracker = WristPronationSupinationTracker()
tracker.analyze_video("video.mp4", "wrist_data.csv")

# Анализ
analyzer = PronationSupinationAnalyzer("wrist_data.csv")
results = analyzer.analyze()
```

## Структура проекта

```
pronation_supination/
├── wrist_tracker.py           # Трекинг кистей (YOLOv11n + MediaPipe)
├── wrist_analyzer.py          # Анализ движений и клиническое скоринг 0-4
├── requirements.txt           # Зависимости
├── README.md                  # Документация
└── yolo11n.pt                 # Веса YOLOv11n (скачиваются автоматически при первом запуске)
```

## Формат входных данных

### JSON файл с матрицей данных

```json
{
  "matrix": [
    [x1, y1, z1, x2, y2, z2, ...],  // Кадр 1: 63 координаты
    [x1, y1, z1, x2, y2, z2, ...],  // Кадр 2: 63 координаты
    ...
  ],
  "fps": 30.0,
  "description": "Описание данных"
}
```

### CSV файл с данными трекинга

```csv
frame,timestamp,hand,angle,hand_0_x,hand_0_y,hand_0_z,...
1,0.033,right,45.2,345.2,120.7,0.12,...
2,0.066,right,47.1,346.1,119.8,0.11,...
```

## Критерии оценки

Система анализирует 8 ключевых критериев:

1. **Достаточная амплитуда** (≥30°)
2. **Достаточное количество циклов** (≥3)
3. **Хорошая ритмичность** (≥0.7)
4. **Хорошая стабильность скорости** (≥0.6)
5. **Хорошая стабильность амплитуды** (≥0.8)
6. **Плавность движений** (≥0.6)
7. **Мало остановок** (≤0.3)
8. **Минимальное уменьшение амплитуды** (≤0.3)

### Шкала оценки:
- **4 балла**: 7-8 критериев выполнены
- **3 балла**: 5-6 критериев выполнены  
- **2 балла**: 3-4 критерия выполнены
- **1 балл**: 1-2 критерия выполнены
- **0 баллов**: 0 критериев выполнены

## Выходные файлы

После обработки создаются файлы:

- `wrist_data.csv` — данные трекинга активной руки (кадры, угол, 21×(x,y,z))
- `analysis_results.csv` — агрегированные метрики и оценки (0-4)
- `wrist_analysis_results.json` — детальная расшифровка анализа

## Примечания

- Для детекции используется `ultralytics` (YOLO) и `mediapipe` (Hand Landmarks).
- Модель `yolov11n.pt` будет загружена автоматически при первом запуске в папку `pronation_supination/`.
- Видеофайлы и большие артефакты рекомендуется исключать из git (см. .gitignore).

## Требования

- Python 3.8+
- OpenCV 4.5+
- MediaPipe 0.10+
- NumPy 1.21+
- Pandas 1.3+
- SciPy 1.7+
- Scikit-learn 1.0+
- Matplotlib 3.5+

## Лицензия

MIT License

## Поддержка

Для вопросов и поддержки обращайтесь к документации или создавайте issues в репозитории.
